<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rysk IV Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #30363d;
        }

        h1 {
            font-size: 24px;
            color: #58a6ff;
        }

        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-size: 12px;
            color: #8b949e;
            text-transform: uppercase;
        }

        select, input {
            padding: 8px 12px;
            border: 1px solid #30363d;
            border-radius: 6px;
            background: #161b22;
            color: #c9d1d9;
            font-size: 14px;
            min-width: 150px;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #58a6ff;
        }

        button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            background: #238636;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }

        button:hover {
            background: #2ea043;
        }

        button.secondary {
            background: #21262d;
            border: 1px solid #30363d;
        }

        button.secondary:hover {
            background: #30363d;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 1000px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
        }

        .card h2 {
            font-size: 16px;
            margin-bottom: 15px;
            color: #8b949e;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #21262d;
        }

        th {
            color: #8b949e;
            font-weight: 500;
            text-transform: uppercase;
            font-size: 11px;
        }

        tr:hover {
            background: #21262d;
        }

        .iv-value {
            font-family: monospace;
        }

        .iv-bid { color: #f85149; }
        .iv-ask { color: #3fb950; }
        .iv-mid { color: #58a6ff; }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #8b949e;
        }

        .status {
            font-size: 12px;
            color: #8b949e;
            margin-top: 10px;
        }

        .auto-refresh {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .auto-refresh input[type="checkbox"] {
            min-width: auto;
            width: 16px;
            height: 16px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat {
            background: #21262d;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #58a6ff;
        }

        .stat-label {
            font-size: 12px;
            color: #8b949e;
            margin-top: 5px;
        }

        @media (max-width: 600px) {
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Rysk IV Tracker</h1>
            <div class="controls">
                <div class="control-group">
                    <label>Asset</label>
                    <select id="asset-select">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Strike</label>
                    <select id="strike-select">
                        <option value="">All Strikes</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Expiry</label>
                    <select id="expiry-select">
                        <option value="">All Expiries</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Days</label>
                    <select id="days-select">
                        <option value="1">1 day</option>
                        <option value="7" selected>7 days</option>
                        <option value="14">14 days</option>
                        <option value="30">30 days</option>
                        <option value="90">90 days</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>&nbsp;</label>
                    <button onclick="refresh()">Refresh</button>
                </div>
                <div class="control-group">
                    <label>&nbsp;</label>
                    <div class="auto-refresh">
                        <input type="checkbox" id="auto-refresh">
                        <span>Auto-refresh</span>
                    </div>
                </div>
            </div>
        </header>

        <div class="stats" id="stats">
            <div class="stat">
                <div class="stat-value" id="stat-assets">-</div>
                <div class="stat-label">Assets Tracked</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-records">-</div>
                <div class="stat-label">Total Records</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-avg-iv">-</div>
                <div class="stat-label">Avg Mid IV</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="stat-last-update">-</div>
                <div class="stat-label">Last Update</div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h2>Implied Volatility Over Time</h2>
                <div class="chart-container">
                    <canvas id="iv-chart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2>IV Distribution by Strike</h2>
                <div class="chart-container">
                    <canvas id="strike-chart"></canvas>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Latest IV Values</h2>
            <div id="table-container">
                <div class="loading">Loading data...</div>
            </div>
            <div class="status" id="status"></div>
        </div>
    </div>

    <script>
        let ivChart = null;
        let strikeChart = null;
        let autoRefreshInterval = null;

        async function fetchAssets() {
            const response = await fetch('/api/assets');
            return await response.json();
        }

        async function fetchStrikesAndExpiries(asset) {
            const response = await fetch(`/api/strikes/${asset}`);
            return await response.json();
        }

        async function fetchIVData(asset, days, strike, expiry) {
            let url = `/api/iv/${asset}?days=${days}`;
            if (strike) url += `&strike=${strike}`;
            if (expiry) url += `&expiry=${expiry}`;
            const response = await fetch(url);
            return await response.json();
        }

        async function fetchLatest(asset) {
            let url = '/api/latest';
            if (asset) url += `?asset=${asset}`;
            const response = await fetch(url);
            return await response.json();
        }

        async function init() {
            const assets = await fetchAssets();
            const assetSelect = document.getElementById('asset-select');

            if (assets.length === 0) {
                assetSelect.innerHTML = '<option value="">No data yet</option>';
                document.getElementById('table-container').innerHTML =
                    '<div class="loading">No data available. Run "python tracker.py fetch" to collect data.</div>';
                return;
            }

            assetSelect.innerHTML = assets.map(a =>
                `<option value="${a}">${a}</option>`
            ).join('');

            assetSelect.addEventListener('change', async () => {
                await updateStrikesAndExpiries();
                await refresh();
            });

            document.getElementById('strike-select').addEventListener('change', refresh);
            document.getElementById('expiry-select').addEventListener('change', refresh);
            document.getElementById('days-select').addEventListener('change', refresh);

            document.getElementById('auto-refresh').addEventListener('change', (e) => {
                if (e.target.checked) {
                    autoRefreshInterval = setInterval(refresh, 60000);
                } else {
                    clearInterval(autoRefreshInterval);
                }
            });

            await updateStrikesAndExpiries();
            await refresh();
        }

        async function updateStrikesAndExpiries() {
            const asset = document.getElementById('asset-select').value;
            if (!asset) return;

            const data = await fetchStrikesAndExpiries(asset);

            const strikeSelect = document.getElementById('strike-select');
            strikeSelect.innerHTML = '<option value="">All Strikes</option>' +
                data.strikes.map(s => `<option value="${s}">${s}</option>`).join('');

            const expirySelect = document.getElementById('expiry-select');
            expirySelect.innerHTML = '<option value="">All Expiries</option>' +
                data.expiries.map(e => `<option value="${e}">${e}</option>`).join('');
        }

        async function refresh() {
            const asset = document.getElementById('asset-select').value;
            const strike = document.getElementById('strike-select').value;
            const expiry = document.getElementById('expiry-select').value;
            const days = document.getElementById('days-select').value;

            if (!asset) return;

            // Fetch data
            const ivData = await fetchIVData(asset, days, strike, expiry);
            const latestData = await fetchLatest(asset);

            // Update stats
            updateStats(ivData, latestData);

            // Update charts
            updateIVChart(ivData);
            updateStrikeChart(latestData);

            // Update table
            updateTable(latestData);

            document.getElementById('status').textContent =
                `Last refreshed: ${new Date().toLocaleTimeString()}`;
        }

        function updateStats(ivData, latestData) {
            const assets = new Set(latestData.map(d => d.asset));
            document.getElementById('stat-assets').textContent = assets.size;
            document.getElementById('stat-records').textContent = ivData.length;

            if (ivData.length > 0) {
                const avgIV = ivData.reduce((sum, d) => sum + (d.mid_iv || 0), 0) / ivData.length;
                document.getElementById('stat-avg-iv').textContent = avgIV.toFixed(2) + '%';

                const lastUpdate = new Date(ivData[ivData.length - 1].timestamp);
                document.getElementById('stat-last-update').textContent =
                    lastUpdate.toLocaleTimeString();
            }
        }

        function updateIVChart(data) {
            const ctx = document.getElementById('iv-chart').getContext('2d');

            // Group by strike/expiry for multiple lines
            const groups = {};
            data.forEach(d => {
                const key = `${d.strike}-${d.expiry}`;
                if (!groups[key]) groups[key] = [];
                groups[key].push(d);
            });

            const datasets = Object.entries(groups).slice(0, 5).map(([key, points], i) => {
                const colors = ['#58a6ff', '#3fb950', '#f85149', '#a371f7', '#f0883e'];
                return {
                    label: key,
                    data: points.map(p => ({
                        x: new Date(p.timestamp),
                        y: p.mid_iv
                    })),
                    borderColor: colors[i % colors.length],
                    backgroundColor: 'transparent',
                    tension: 0.3,
                    pointRadius: 2
                };
            });

            if (ivChart) ivChart.destroy();

            ivChart = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { color: '#8b949e', boxWidth: 12 }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'hour' },
                            grid: { color: '#21262d' },
                            ticks: { color: '#8b949e' }
                        },
                        y: {
                            title: { display: true, text: 'IV %', color: '#8b949e' },
                            grid: { color: '#21262d' },
                            ticks: { color: '#8b949e' }
                        }
                    }
                }
            });
        }

        function updateStrikeChart(data) {
            const ctx = document.getElementById('strike-chart').getContext('2d');

            // Group by strike
            const strikeData = {};
            data.forEach(d => {
                if (!strikeData[d.strike]) {
                    strikeData[d.strike] = { bid: [], ask: [], mid: [] };
                }
                if (d.bid_iv) strikeData[d.strike].bid.push(d.bid_iv);
                if (d.ask_iv) strikeData[d.strike].ask.push(d.ask_iv);
                if (d.mid_iv) strikeData[d.strike].mid.push(d.mid_iv);
            });

            const strikes = Object.keys(strikeData).sort((a, b) => a - b);
            const avgMid = strikes.map(s => {
                const mids = strikeData[s].mid;
                return mids.length ? mids.reduce((a, b) => a + b, 0) / mids.length : 0;
            });

            if (strikeChart) strikeChart.destroy();

            strikeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: strikes,
                    datasets: [{
                        label: 'Avg Mid IV',
                        data: avgMid,
                        backgroundColor: '#58a6ff',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Strike', color: '#8b949e' },
                            grid: { color: '#21262d' },
                            ticks: { color: '#8b949e' }
                        },
                        y: {
                            title: { display: true, text: 'IV %', color: '#8b949e' },
                            grid: { color: '#21262d' },
                            ticks: { color: '#8b949e' }
                        }
                    }
                }
            });
        }

        function updateTable(data) {
            if (data.length === 0) {
                document.getElementById('table-container').innerHTML =
                    '<div class="loading">No data available</div>';
                return;
            }

            const rows = data.map(d => `
                <tr>
                    <td>${d.asset}</td>
                    <td>${d.strike}</td>
                    <td>${d.expiry}</td>
                    <td>${d.option_type || '-'}</td>
                    <td class="iv-value iv-bid">${d.bid_iv ? d.bid_iv.toFixed(2) + '%' : '-'}</td>
                    <td class="iv-value iv-ask">${d.ask_iv ? d.ask_iv.toFixed(2) + '%' : '-'}</td>
                    <td class="iv-value iv-mid">${d.mid_iv ? d.mid_iv.toFixed(2) + '%' : '-'}</td>
                </tr>
            `).join('');

            document.getElementById('table-container').innerHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Asset</th>
                            <th>Strike</th>
                            <th>Expiry</th>
                            <th>Type</th>
                            <th>Bid IV</th>
                            <th>Ask IV</th>
                            <th>Mid IV</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;
        }

        init();
    </script>
</body>
</html>
